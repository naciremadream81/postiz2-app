FROM node:20-alpine3.19

# Build arguments for configuration
ARG NEXT_PUBLIC_VERSION
ARG NODE_MAX_MEMORY=4096
ARG PNPM_VERSION=10.6.1

# Set environment variables
ENV NEXT_PUBLIC_VERSION=$NEXT_PUBLIC_VERSION \
    NODE_ENV=production \
    PNPM_HOME=/usr/local/bin

# Install system dependencies in a single layer and clean up
# - g++, make, py3-pip: Required for native module compilation
# - bash: Required for scripts
# - nginx: Web server for serving static files
RUN apk add --no-cache \
    g++ \
    make \
    py3-pip \
    bash \
    nginx \
    && rm -rf /var/cache/apk/*

# Create non-root user and set up directories with proper permissions
# Security best practice: Never run production containers as root
RUN adduser -D -g 'www' www \
    && mkdir -p /www /app \
    && chown -R www:www /var/lib/nginx /www /app

# Install global npm packages as root (required for global installs)
RUN npm --no-update-notifier --no-fund --global install pnpm@${PNPM_VERSION} pm2

# Switch to working directory
WORKDIR /app

# Copy dependency manifests first for better layer caching
# This allows Docker to cache the pnpm install layer unless dependencies change
COPY --chown=www:www package.json pnpm-lock.yaml pnpm-workspace.yaml ./

# Copy package.json files from all workspace packages
# This ensures pnpm can resolve the workspace structure
COPY --chown=www:www apps/backend/package.json ./apps/backend/
COPY --chown=www:www apps/commands/package.json ./apps/commands/
COPY --chown=www:www apps/cron/package.json ./apps/cron/
COPY --chown=www:www apps/extension/package.json ./apps/extension/
COPY --chown=www:www apps/frontend/package.json ./apps/frontend/
COPY --chown=www:www apps/sdk/package.json ./apps/sdk/
COPY --chown=www:www apps/workers/package.json ./apps/workers/
COPY --chown=www:www libraries/nestjs-libraries/package.json ./libraries/nestjs-libraries/
COPY --chown=www:www libraries/react-shared-libraries/package.json ./libraries/react-shared-libraries/
COPY --chown=www:www libraries/helpers/package.json ./libraries/helpers/

# Install dependencies as root (pnpm may need elevated permissions for some operations)
# This layer will be cached unless package files change
RUN pnpm install --frozen-lockfile

# Copy application source code and configuration files
COPY --chown=www:www . /app
COPY --chown=www:www var/docker/nginx.conf /etc/nginx/nginx.conf

# Build application with configurable memory limit
# Increase memory for large Next.js builds to prevent out-of-memory errors
RUN NODE_OPTIONS="--max-old-space-size=${NODE_MAX_MEMORY}" pnpm run build

# Switch to non-root user for running the application
# Security best practice: Run application processes with minimal privileges
USER www

# Expose ports (documentation only, actual exposure controlled by docker-compose)
EXPOSE 80 3000 4200

# Health check to ensure the application is running correctly
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:80/health || exit 1

# Start nginx and application using PM2
# Using exec form to ensure proper signal handling
CMD ["sh", "-c", "nginx && pnpm run pm2"]
